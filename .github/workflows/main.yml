name: Build & Deploy Godot 4.5 Web

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GODOT_VERSION: "4.5-stable"
  EXPORT_PRESET: "Web"           # –∏–º—è –∏–∑ export_presets.cfg
  EXPORT_PATH: "build/web"

jobs:
  build:
    name: Build HTML5
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Godot (headless) + —ç–∫—Å–ø–æ—Ä—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
      - name: Install Godot 4.5
        run: |
          echo "‚¨áÔ∏è Downloading Godot ${GODOT_VERSION}..."
          wget https://downloads.tuxfamily.org/godotengine/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_linux.x86_64.zip -O godot.zip
          unzip godot.zip
          mv Godot_v${GODOT_VERSION}_linux.x86_64 godot
          chmod +x godot

          echo "‚¨áÔ∏è Downloading export templates..."
          mkdir -p ~/.local/share/godot/templates/${GODOT_VERSION}/
          wget https://downloads.tuxfamily.org/godotengine/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_export_templates.tpz -O templates.tpz
          unzip templates.tpz -d ~/.local/share/godot/templates/${GODOT_VERSION}/

          echo "‚úÖ Godot installed successfully."

      # 3Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º HTML5 —ç–∫—Å–ø–æ—Ä—Ç
      - name: Export Web build
        run: |
          mkdir -p ${EXPORT_PATH}
          ./godot --headless --export-release "${EXPORT_PRESET}" "${EXPORT_PATH}/index.html"

      # 4Ô∏è‚É£ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∏–ª–¥ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: ${{ env.EXPORT_PATH }}

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # 5Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–ª–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ job
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: ./public

      # 6Ô∏è‚É£ –ü—É–±–ª–∏–∫—É–µ–º –Ω–∞ GitHub Pages
      - name: Deploy üöÄ
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
